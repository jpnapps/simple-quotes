name: Play Store Internal Release (Manual) and Professional Pipeline

#on:
#  workflow_dispatch:   # üëà Manual run only

on:
  workflow_dispatch:
    inputs:
      promote_to_production:
        description: 'Set to "true" to promote the current Internal build to Production'
        required: true
        default: 'false'
        type: boolean

jobs:
  # --- JOB 1: BUILD & UPLOAD TO INTERNAL ---
  build-and-internal:
    if: github.event.inputs.promote_to_production == 'false'
    runs-on: ubuntu-latest
    steps:
      # 1Ô∏è‚É£ Checkout source code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Java (Android requires JDK)
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3Ô∏è‚É£ Decode keystore (original name)
      - name: Decode keystore
        run: |
           echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > app/simple_quotes.jks
           ls -lh app/simple_quotes.jks

      # 4Ô∏è‚É£ Create keystore.properties
      #- name: Create keystore properties
        #run: |
          #echo "storeFile=simple_quotes.jks" >> keystore.properties
          #echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> keystore.properties
          #echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> keystore.properties
          #echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties

      # 5Ô∏è‚É£ Grant Gradle permission
      - name: Grant execute permission
        run: chmod +x gradlew

      # 6Ô∏è‚É£ Run Android Lint (quality gate)
      - name: Run Lint
        run: ./gradlew lintRelease

#      # 5Ô∏è‚É£ Run Unit Tests
#      - name: Run Unit Tests
#        run: ./gradlew testReleaseUnitTest

      # 6Ô∏è‚É£ Build Release AAB
      - name: Build Release Bundle
        env:
          #GITHUB_RUN_NUMBER: ${{ github.run_number }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew bundleRelease

      # 7Ô∏è‚É£ Upload to Play Store (Internal Testing)
      - name: Upload to Play Store - Internal
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.jpdev.simplequotes   # üî¥ replace this
          releaseFiles: app/build/outputs/bundle/release/app-release.aab
          track: internal
          status: draft
          #status: completed
          whatsNewDirectory: whatsnew/ # Points to the folder containing 'en-US'

# --- JOB 2: PROMOTE INTERNAL TO PRODUCTION ---
  promote-production:
    if: github.event.inputs.promote_to_production == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Promote Release
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.jpdev.simplequotes
          track: production      # Target destination
          trackPromote: internal  # Source of the "Same Build"
          status: inProgress
          userFraction: 0.30      # Best Practice: 30% Rollout
          whatsNewDirectory: whatsnew/